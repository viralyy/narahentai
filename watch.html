<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Watch • Narahentai</title>

<style>
:root{
 --bg:#0b0b0f;
 --txt:#f3f4ff;
 --mut:#a6a7c2;
 --bd:1px solid rgba(255,255,255,.10);
 --card:rgba(255,255,255,.05);
 --br:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--txt)}
a{text-decoration:none;color:inherit}

.header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:10px 14px;
 border-bottom:var(--bd);
 backdrop-filter:blur(10px);
 background:rgba(11,11,15,.8);
 position:sticky;top:0;
}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.logo{
 width:32px;height:32px;border-radius:10px;
 background:linear-gradient(135deg,#ff4db4,#5f42ff);
}
.btn{
 border:var(--bd);
 padding:8px 12px;
 border-radius:999px;
 font-size:13px;
 background:rgba(255,255,255,.06);
}

.wrap{max-width:980px;margin:auto;padding:14px}

.player{
 border:var(--bd);
 border-radius:var(--br);
 overflow:hidden;
 background:#000;
}
video{
 width:100%;
 aspect-ratio:16/9;
 display:block;
}

h1{margin:14px 0 6px;font-size:20px}
.meta{
 display:flex;
 flex-wrap:wrap;
 gap:8px;
 font-size:12px;
 color:var(--mut);
 margin-bottom:10px;
}
.pill{
 border:var(--bd);
 padding:4px 8px;
 border-radius:999px;
}

.desc{
 border:var(--bd);
 border-radius:var(--br);
 padding:12px;
 background:var(--card);
 color:var(--mut);
 white-space:pre-wrap;
}

.section{
 margin-top:18px;
 font-size:14px;
 color:var(--mut);
}

.grid{
 margin-top:10px;
 display:grid;
 grid-template-columns:repeat(2,1fr);
 gap:12px;
}
@media (min-width:1024px){
 .grid{grid-template-columns:repeat(5,1fr);}
}

.card{
 border:var(--bd);
 border-radius:var(--br);
 overflow:hidden;
 background:var(--card);
}
.thumb{
 width:100%;
 aspect-ratio:16/9;
 object-fit:cover;
 background:#111;
}
.pad{padding:10px}
.ctitle{font-weight:800}
.cmeta{font-size:12px;color:var(--mut);margin-top:6px}

footer{
 margin-top:20px;
 padding-top:14px;
 border-top:var(--bd);
 font-size:12px;
 color:var(--mut);
 display:flex;
 justify-content:space-between;
 flex-wrap:wrap;
}
</style>
</head>
<body>

<div class="header">
 <a class="brand" href="/">
   <div class="logo"></div>
   Narahentai
 </a>
 <div style="display:flex;gap:8px">
   <a class="btn" href="/">Back</a>
 </div>
</div>

<div class="wrap">
 <div class="player">
   <video id="v" controls></video>
 </div>

 <h1 id="title">Loading...</h1>

 <div class="meta" id="meta">
   <div class="pill">Views: -</div>
   <div class="pill">Publish: -</div>
   <div class="pill">Durasi: - menit</div>
  </div>

 <div class="desc" id="desc"></div>

 <div class="section">Rekomendasi lainnya</div>
 <div class="grid" id="rec"></div>

 <footer>
   <div>© <span id="year"></span> Narahentai</div>
   <div>Built on Cloudflare Pages</div>
 </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
document.getElementById("year").textContent = new Date().getFullYear();

function fmt(d){ try { return new Date(d).toLocaleString("id-ID"); } catch { return ""; } }

async function main(){
  const slug = new URL(location.href).searchParams.get("slug");
  if(!slug){
    document.getElementById("title").textContent = "Video tidak ditemukan";
    return;
  }

  const r = await fetch("/api/post?slug=" + encodeURIComponent(slug), { cache: "no-store" });
  if(!r.ok){
    document.getElementById("title").textContent = "Video tidak ditemukan";
    return;
  }
  const p = await r.json();

  document.getElementById("title").textContent = p.title || "Untitled";
  document.getElementById("desc").textContent = p.description || "";
  document.getElementById("meta").innerHTML = `
    <div class="pill">Views: ${p.views||0}</div>
    <div class="pill">Publish: ${fmt(p.published_at||p.created_at)}</div>
    <div class="pill">Durasi: ${p.duration_minutes||0} menit</div>
  `;

  fetch("/api/view?slug=" + encodeURIComponent(slug), {
    method: "POST",
    cache: "no-store",
    keepalive: true
  })
  .then(r => r.json())
  .then(x => {
    if (x && x.ok) {
      document.querySelector("#meta .pill").textContent = "Views: " + x.views;
    }
  })
  .catch(()=>{});

  const video = document.getElementById("v");
  const url = p.video_url || "";

  if(url.endsWith(".m3u8")){
    if(video.canPlayType("application/vnd.apple.mpegurl")){
      video.src = url;
    }else{
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    }
  }else{
    video.src = url;
  }

  const list = await fetch("/api/posts?page=1&q=", { cache: "no-store" });
  const data = await list.json();
  const items = (data.items || []).filter(x => x.slug !== slug).slice(0, 10);

  document.getElementById("rec").innerHTML = items.map(x => `
    <a class="card" href="/watch.html?slug=${encodeURIComponent(x.slug)}">
      <img class="thumb" src="${x.thumbnail_url||""}">
      <div class="pad">
        <div class="ctitle">${x.title||""}</div>
        <div class="cmeta">${x.views||0} views</div>
      </div>
    </a>
  `).join("");
}

main();
</script>

<!-- ✅ IKLAN DITAMBAHKAN (tidak mengubah bagian lain) -->
<script>
(function(s){
  s.dataset.zone = '10109877';
  s.src = 'https://al5sm.com/tag.min.js';
})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')));
</script>

</body>
</html>
