<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <meta name="theme-color" content="#0b0b0f" />
  <style>
    :root{
      --bg:#0b0b0f; --card:#12121a; --txt:#f3f4ff; --mut:#a6a7c2;
      --bd:1px solid rgba(255,255,255,.10); --br:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:24px}
    a{color:#8ab4ff;text-decoration:none}
    .grid{margin-top:14px;display:grid;grid-template-columns: 380px 1fr;gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(255,255,255,.05);border:var(--bd);border-radius:var(--br);padding:14px}
    label{display:block;margin:10px 0 6px;color:var(--mut);font-size:12px}
    input, textarea{
      width:100%;border-radius:14px;border:var(--bd);background:rgba(0,0,0,.25);
      color:var(--txt);padding:11px 12px;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{
      border:var(--bd);background:rgba(255,255,255,.06);color:var(--txt);
      padding:10px 12px;border-radius:999px;cursor:pointer;font-size:13px
    }
    .btn.primary{border-color:rgba(95,66,255,.55)}
    .btn.danger{border-color:rgba(255,92,92,.65)}
    .hint{color:var(--mut);font-size:12px;line-height:1.5}
    .list{display:grid;gap:10px}
    .item{border:var(--bd);border-radius:16px;padding:12px;background:rgba(0,0,0,.20)}
    .itop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .tag{font-size:11px;padding:6px 10px;border-radius:999px;border:var(--bd);color:var(--mut)}
    .title{font-weight:800}
    .meta{margin-top:6px;color:var(--mut);font-size:12px}
    .mini{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .msg{margin-top:10px;color:var(--mut);font-size:12px;white-space:pre-wrap}
    .search{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Admin</h1>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <label>Password Admin</label>
        <input id="pass" type="password" placeholder="ADMIN_PASSWORD" />

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

        <input id="id" type="hidden" />

        <label>Title</label>
        <input id="title" placeholder="Judul video" />

        <div class="row2">
          <div>
            <label>Slug</label>
            <input id="slug" placeholder="auto dari title" />
          </div>
          <div>
            <label>Thumbnail URL</label>
            <input id="thumb" placeholder="https://...jpg" />
          </div>
        </div>

        <label>Video URL</label>
        <input id="video" placeholder="https://...mp4 atau ...m3u8" />

        <label>Durasi</label>
        <input id="dur" type="number" min="0" step="1" placeholder="contoh: 24" />

        <label>Description</label>
        <textarea id="desc" placeholder="Deskripsi..."></textarea>

        <label style="display:flex;align-items:center;gap:10px;margin-top:10px">
          <input id="published" type="checkbox" style="width:auto;transform:scale(1.15)" />
          Publish
        </label>

        <div class="btns">
          <button class="btn primary" onclick="save()">Save</button>
          <button class="btn" onclick="resetForm()">New</button>
          <button class="btn danger" onclick="del()">Delete</button>
          <button class="btn" onclick="load()">Refresh</button>
        </div>

        <div class="msg" id="msg"></div>
      </div>

      <div class="card">
        <div class="search">
          <input id="q" placeholder="Cari post…" />
          <button class="btn" onclick="load()">Reload</button>
        </div>
        <div style="height:10px"></div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let all = [];

    $("pass").value = localStorage.getItem("admin_pass") || "";
    $("pass").addEventListener("input", () => localStorage.setItem("admin_pass", $("pass").value));

    function headers(){
      return {
        "content-type": "application/json",
        "x-admin-password": $("pass").value || ""
      };
    }
    function setMsg(t){ $("msg").textContent = t || ""; }
    function fmt(iso){ try{return new Date(iso).toLocaleString("id-ID");}catch{return "";} }
    function esc(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function resetForm(){
      $("id").value = "";
      $("title").value = "";
      $("slug").value = "";
      $("thumb").value = "";
      $("video").value = "";
      $("dur").value = "";
      $("desc").value = "";
      $("published").checked = false;
      setMsg("");
    }

    function render(list){
      const q = ($("q").value || "").trim().toLowerCase();
      const filtered = q ? list.filter(p =>
        (p.title||"").toLowerCase().includes(q) || (p.slug||"").toLowerCase().includes(q)
      ) : list;

      const el = $("list");
      if (!filtered.length){
        el.innerHTML = `<div class="hint">Belum ada post.</div>`;
        return;
      }

      el.innerHTML = filtered.map(p => `
        <div class="item">
          <div class="itop">
            <div>
              <div class="title">${esc(p.title)}</div>
              <div class="meta">slug: ${esc(p.slug)} • updated: ${fmt(p.updated_at)}</div>
            </div>
            <div class="tag">${p.published ? "PUBLISHED" : "DRAFT"}</div>
          </div>
          <div class="meta" style="margin-top:8px">video: ${esc(p.video_url || "")}</div>
          <div class="meta">durasi: ${(p.duration_minutes||0)} menit • views: ${(p.views||0)}</div>
          <div class="mini">
            <button class="btn" onclick='edit(${JSON.stringify(p)})'>Edit</button>
            <a class="btn" href="/watch.html?slug=${encodeURIComponent(p.slug)}" target="_blank">Open</a>
          </div>
        </div>
      `).join("");
    }

    async function load(){
      setMsg("");
      const res = await fetch("/api/admin-list", { headers: headers(), cache: "no-store" });
      const text = await res.text();
      if (!res.ok) { setMsg("Error: " + text); return; }
      all = JSON.parse(text);
      render(all);
    }

    $("q").addEventListener("input", () => render(all));

    window.edit = function(p){
      $("id").value = p.id;
      $("title").value = p.title || "";
      $("slug").value = p.slug || "";
      $("thumb").value = p.thumbnail_url || "";
      $("video").value = p.video_url || "";
      $("dur").value = p.duration_minutes || 0;
      $("desc").value = p.description || "";
      $("published").checked = !!p.published;
      setMsg("Editing id=" + p.id);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    window.save = async function(){
      setMsg("");
      const payload = {
        id: $("id").value ? Number($("id").value) : null,
        title: $("title").value.trim(),
        slug: $("slug").value.trim(),
        thumbnail_url: $("thumb").value.trim(),
        video_url: $("video").value.trim(),
        duration_minutes: Number($("dur").value || 0),
        description: $("desc").value.trim(),
        published: $("published").checked
      };
      const res = await fetch("/api/admin-upsert", {
        method: "POST",
        headers: headers(),
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      if (!res.ok) { setMsg("Error: " + text); return; }
      setMsg("Saved ✅");
      await load();
    }

    window.del = async function(){
      setMsg("");
      const id = $("id").value ? Number($("id").value) : null;
      if (!id) return setMsg("Pilih post dulu (Edit) baru Delete.");

      const res = await fetch("/api/admin-delete", {
        method: "POST",
        headers: headers(),
        body: JSON.stringify({ id })
      });
      const text = await res.text();
      if (!res.ok) { setMsg("Error: " + text); return; }
      setMsg("Deleted ✅");
      resetForm();
      await load();
    }

    load();
  </script>
</body>
</html>
